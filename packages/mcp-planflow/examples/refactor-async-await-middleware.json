{
  "schemaVersion": "1.1.0",
  "planType": "refactor",
  "metadata": {
    "title": "Refactor Authentication Middleware to Async/Await",
    "description": "Modernize authentication middleware from callback pattern to async/await with better error handling",
    "author": "backend-team",
    "tags": ["refactor", "authentication", "async-await", "middleware"]
  },
  "plan": {
    "objective": "Replace callback-based authentication with modern async/await pattern",
    "scope": "Authentication middleware and related utility functions",
    "constraints": [
      "Must maintain backward compatibility with existing routes",
      "Must not change API behavior",
      "Must improve error handling"
    ],
    "assumptions": [
      "Node.js version supports async/await",
      "JWT library supports promises"
    ],
    "successCriteria": [
      "All middleware uses async/await",
      "Error handling is more explicit",
      "All existing tests still pass",
      "Code is more readable"
    ]
  },
  "steps": [
    {
      "id": "refactor-jwt-utils",
      "title": "Convert JWT utilities to async/await",
      "description": "Refactor jwt.verify callback to promise-based approach",
      "kind": "edit_file",
      "status": "pending",
      "dependsOn": [],
      "estimatedDuration": {
        "value": 30,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "edit_file",
          "filePath": "src/utils/jwt.ts",
          "before": "import jwt from 'jsonwebtoken';\n\nexport function verifyToken(token: string, callback: (err: Error | null, decoded?: any) => void) {\n  jwt.verify(token, process.env.JWT_SECRET!, (err, decoded) => {\n    if (err) {\n      return callback(err);\n    }\n    callback(null, decoded);\n  });\n}",
          "after": "import jwt from 'jsonwebtoken';\nimport { promisify } from 'util';\n\nconst verifyJwt = promisify(jwt.verify);\n\nexport async function verifyToken(token: string): Promise<any> {\n  try {\n    const decoded = await verifyJwt(token, process.env.JWT_SECRET!);\n    return decoded;\n  } catch (error) {\n    throw new Error('Invalid token');\n  }\n}",
          "description": "Convert verifyToken to async/await using promisify",
          "lineNumbers": {
            "start": 1,
            "end": 10
          }
        }
      ],
      "validation": {
        "criteria": [
          "Function returns a Promise",
          "Error handling is clear",
          "Type safety is maintained"
        ]
      }
    },
    {
      "id": "refactor-auth-middleware",
      "title": "Modernize authenticate middleware",
      "description": "Convert authentication middleware to async/await pattern with improved error handling",
      "kind": "edit_file",
      "status": "pending",
      "dependsOn": ["refactor-jwt-utils"],
      "estimatedDuration": {
        "value": 45,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "edit_file",
          "filePath": "src/middleware/auth.ts",
          "before": "import { Request, Response, NextFunction } from 'express';\nimport { verifyToken } from '../utils/jwt';\n\nexport function authenticate(req: Request, res: Response, next: NextFunction) {\n  const token = req.headers.authorization;\n  \n  if (!token) {\n    return res.status(401).json({ error: 'No token provided' });\n  }\n  \n  verifyToken(token.replace('Bearer ', ''), (err, decoded) => {\n    if (err) {\n      return res.status(401).json({ error: 'Invalid token' });\n    }\n    \n    req.user = decoded;\n    next();\n  });\n}",
          "after": "import { Request, Response, NextFunction } from 'express';\nimport { verifyToken } from '../utils/jwt';\n\nexport async function authenticate(req: Request, res: Response, next: NextFunction) {\n  try {\n    const authHeader = req.headers.authorization;\n    \n    if (!authHeader) {\n      return res.status(401).json({ \n        error: 'No token provided',\n        code: 'MISSING_TOKEN'\n      });\n    }\n    \n    const token = authHeader.replace('Bearer ', '');\n    const decoded = await verifyToken(token);\n    \n    req.user = decoded;\n    next();\n  } catch (error) {\n    return res.status(401).json({ \n      error: 'Invalid or expired token',\n      code: 'INVALID_TOKEN'\n    });\n  }\n}",
          "description": "Convert to async/await with structured error handling",
          "lineNumbers": {
            "start": 1,
            "end": 19
          }
        }
      ],
      "validation": {
        "criteria": [
          "Middleware is async",
          "Error responses include error codes",
          "Token extraction is more robust"
        ]
      }
    },
    {
      "id": "refactor-role-middleware",
      "title": "Update role-based authorization middleware",
      "description": "Apply async/await pattern to role checking middleware",
      "kind": "edit_file",
      "status": "pending",
      "dependsOn": ["refactor-auth-middleware"],
      "estimatedDuration": {
        "value": 30,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "edit_file",
          "filePath": "src/middleware/authorize.ts",
          "before": "import { Request, Response, NextFunction } from 'express';\n\nexport function requireRole(role: string) {\n  return function(req: Request, res: Response, next: NextFunction) {\n    if (!req.user) {\n      return res.status(401).json({ error: 'Unauthorized' });\n    }\n    \n    if (req.user.role !== role) {\n      return res.status(403).json({ error: 'Forbidden' });\n    }\n    \n    next();\n  };\n}",
          "after": "import { Request, Response, NextFunction } from 'express';\n\nexport function requireRole(...allowedRoles: string[]) {\n  return async function(req: Request, res: Response, next: NextFunction) {\n    try {\n      if (!req.user) {\n        return res.status(401).json({ \n          error: 'Authentication required',\n          code: 'NOT_AUTHENTICATED'\n        });\n      }\n      \n      if (!allowedRoles.includes(req.user.role)) {\n        return res.status(403).json({ \n          error: 'Insufficient permissions',\n          code: 'FORBIDDEN',\n          requiredRoles: allowedRoles\n        });\n      }\n      \n      next();\n    } catch (error) {\n      return res.status(500).json({ \n        error: 'Authorization check failed',\n        code: 'AUTH_ERROR'\n      });\n    }\n  };\n}",
          "description": "Add async, support multiple roles, improve error messages",
          "lineNumbers": {
            "start": 1,
            "end": 15
          }
        }
      ],
      "validation": {
        "criteria": [
          "Supports multiple allowed roles",
          "Error responses are structured",
          "Async pattern is consistent"
        ]
      }
    },
    {
      "id": "update-route-handlers",
      "title": "Update route handlers to use async middleware",
      "description": "Ensure all route definitions properly handle async middleware",
      "kind": "edit_file",
      "status": "pending",
      "dependsOn": ["refactor-auth-middleware", "refactor-role-middleware"],
      "estimatedDuration": {
        "value": 20,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "edit_file",
          "filePath": "src/routes/user.ts",
          "before": "import { Router } from 'express';\nimport { authenticate } from '../middleware/auth';\nimport { requireRole } from '../middleware/authorize';\nimport * as userController from '../controllers/user';\n\nconst router = Router();\n\nrouter.get('/profile', authenticate, userController.getProfile);\nrouter.put('/profile', authenticate, userController.updateProfile);\nrouter.delete('/users/:id', authenticate, requireRole('admin'), userController.deleteUser);\n\nexport default router;",
          "after": "import { Router } from 'express';\nimport { authenticate } from '../middleware/auth';\nimport { requireRole } from '../middleware/authorize';\nimport * as userController from '../controllers/user';\nimport { asyncHandler } from '../utils/asyncHandler';\n\nconst router = Router();\n\nrouter.get('/profile', authenticate, asyncHandler(userController.getProfile));\nrouter.put('/profile', authenticate, asyncHandler(userController.updateProfile));\nrouter.delete(\n  '/users/:id', \n  authenticate, \n  requireRole('admin', 'moderator'),\n  asyncHandler(userController.deleteUser)\n);\n\nexport default router;",
          "description": "Wrap async handlers and use new requireRole API",
          "lineNumbers": {
            "start": 1,
            "end": 12
          }
        }
      ],
      "validation": {
        "criteria": [
          "Routes properly handle async errors",
          "Multiple roles can be specified"
        ]
      }
    },
    {
      "id": "create-async-handler-utility",
      "title": "Create async error handler utility",
      "description": "Add a utility to wrap async route handlers and catch errors",
      "kind": "create_file",
      "status": "pending",
      "dependsOn": ["refactor-auth-middleware"],
      "estimatedDuration": {
        "value": 15,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "create_file",
          "filePath": "src/utils/asyncHandler.ts",
          "content": "import { Request, Response, NextFunction, RequestHandler } from 'express';\n\n/**\n * Wraps async route handlers to catch promise rejections\n * and forward them to Express error handling middleware\n */\nexport function asyncHandler(\n  fn: (req: Request, res: Response, next: NextFunction) => Promise<any>\n): RequestHandler {\n  return (req: Request, res: Response, next: NextFunction) => {\n    Promise.resolve(fn(req, res, next)).catch(next);\n  };\n}",
          "description": "Create utility to handle async errors in Express"
        }
      ],
      "validation": {
        "criteria": [
          "Utility properly catches async errors",
          "Type definitions are correct"
        ]
      }
    },
    {
      "id": "update-tests",
      "title": "Update middleware tests for async behavior",
      "description": "Modify existing tests to properly test async middleware",
      "kind": "test",
      "status": "pending",
      "dependsOn": ["refactor-auth-middleware", "refactor-role-middleware"],
      "estimatedDuration": {
        "value": 1,
        "unit": "hours"
      },
      "actions": [
        {
          "type": "test",
          "testCommand": "npm test -- --testPathPattern=middleware",
          "coverage": 85,
          "description": "Run all middleware tests and verify coverage"
        }
      ],
      "validation": {
        "criteria": [
          "All tests pass",
          "Async behavior is properly tested",
          "Coverage maintained above 85%"
        ],
        "automatedTests": [
          "middleware/auth.test.ts",
          "middleware/authorize.test.ts"
        ]
      }
    },
    {
      "id": "remove-deprecated-code",
      "title": "Remove old callback-based utilities",
      "description": "Clean up deprecated callback-based helper functions that are no longer used",
      "kind": "delete_file",
      "status": "pending",
      "dependsOn": ["update-tests"],
      "estimatedDuration": {
        "value": 10,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "delete_file",
          "filePath": "src/utils/jwt.legacy.ts",
          "reason": "Replaced by promise-based jwt.ts utilities",
          "description": "Remove legacy callback-based JWT utilities"
        }
      ],
      "validation": {
        "criteria": [
          "No references to deleted file exist",
          "All imports are updated"
        ]
      }
    },
    {
      "id": "update-documentation",
      "title": "Update middleware documentation",
      "description": "Document the new async/await patterns and error codes",
      "kind": "documentation",
      "status": "pending",
      "dependsOn": ["refactor-auth-middleware", "refactor-role-middleware"],
      "estimatedDuration": {
        "value": 30,
        "unit": "minutes"
      },
      "actions": [
        {
          "type": "documentation",
          "filePath": "docs/middleware.md",
          "format": "markdown",
          "sections": [
            "Authentication Middleware",
            "Authorization Middleware",
            "Error Codes Reference",
            "Migration Guide from Callbacks"
          ],
          "description": "Update middleware documentation with async patterns"
        }
      ],
      "validation": {
        "criteria": [
          "Documentation is clear and complete",
          "All error codes are documented",
          "Examples use async/await"
        ]
      }
    }
  ]
}
